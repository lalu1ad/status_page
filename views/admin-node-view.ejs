<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= node.name %> - <%= settings.site_name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <style>
        :root {
            --primary-color: <%= settings.primary_color || '#6366f1' %>;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
        }
        .sidebar {
            background: #1a1c23;
            min-height: 100vh;
            color: white;
        }
        .sidebar .nav-link {
            color: #b0b3b8;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        .metric-card { 
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .status-online { color: var(--success-color); }
        .status-offline { color: var(--danger-color); }
        .progress-thin {
            height: 6px;
            border-radius: 3px;
        }
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .resource-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e9ecef;
        }
        .usage-high { color: var(--danger-color); }
        .usage-medium { color: var(--warning-color); }
        .usage-low { color: var(--success-color); }
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        .stat-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }
        .network-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px;
            padding: 1rem;
        }
        .system-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e9ecef;
        }
        .info-label {
            color: #6c757d;
            font-weight: 500;
        }
        .info-value {
            color: #495057;
            font-weight: 600;
        }
        .swap-indicator {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 8px;
            padding: 1rem;
        }
        .temperature-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .temp-bar {
            flex-grow: 1;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            overflow: hidden;
            margin: 0 10px;
            position: relative;
        }
        .temp-fill {
            height: 100%;
            background: linear-gradient(to right, #10b981, #f59e0b, #ef4444);
        }
        .temp-marker {
            position: absolute;
            height: 12px;
            width: 2px;
            background: rgba(0,0,0,0.3);
            top: -3px;
        }
        .chart-tabs .nav-link {
            border-radius: 0;
            border: none;
            border-bottom: 3px solid transparent;
            color: #6c757d;
            font-weight: 500;
        }
        .chart-tabs .nav-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: transparent;
        }
        .chart-controls {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        .api-key-container {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            border-radius: 8px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }
        .api-key-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-color), #8b5cf6);
        }
        .node-header-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .real-time-badge {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        .metric-trend {
            font-size: 0.8rem;
            display: flex;
            align-items: center;
        }
        .trend-up { color: #ef4444; }
        .trend-down { color: #10b981; }
        .trend-neutral { color: #6b7280; }
        .export-btn-group {
            position: relative;
        }
        .export-dropdown {
            position: absolute;
            right: 0;
            top: 100%;
            display: none;
            min-width: 200px;
            z-index: 1000;
        }
        .export-btn-group:hover .export-dropdown {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-server me-2"></i><%= settings.site_name %>
                    </h4>
                    
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="/admin">
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/nodes">
                                <i class="fas fa-server me-2"></i>Nodes
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/alerts">
                                <i class="fas fa-bell me-2"></i>Alerts
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/users">
                                <i class="fas fa-users me-2"></i>Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/settings">
                                <i class="fas fa-cog me-2"></i>Settings
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/audit">
                                <i class="fas fa-clipboard-list me-2"></i>Audit Logs
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/admin/profile">
                                <i class="fas fa-user me-2"></i>Profile
                            </a>
                        </li>
                        <!-- Export/Backup Menu -->
                        <% if (user.role === 'admin' || user.role === 'manager') { %>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#exportMenu">
                                <i class="fas fa-database me-2"></i>Data Management
                                <i class="fas fa-chevron-down float-end mt-1"></i>
                            </a>
                            <div class="collapse" id="exportMenu">
                                <ul class="nav flex-column ps-3">
                                    <li class="nav-item">
                                        <a class="nav-link" href="/admin/backup">
                                            <i class="fas fa-download me-2"></i>Backup DB
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="/admin/export/stats">
                                            <i class="fas fa-file-export me-2"></i>Export Stats
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <% } %>
                        <li class="nav-item mt-3">
                            <a class="nav-link text-danger" href="/admin/logout">
                                <i class="fas fa-sign-out-alt me-2"></i>Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-4">
                <!-- Navbar -->
                <nav class="navbar navbar-light bg-white border-bottom py-3">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <a href="/admin/nodes" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <span class="navbar-brand">
                                <i class="fas fa-server me-2"></i><%= node.name %>
                                <small class="ms-2 text-muted">ID: <%= node.id %></small>
                            </span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="me-3 text-end">
                                <small class="text-muted d-block">v7.0 Ultimate Edition</small>
                                <span><%= user.full_name %> (<%= user.role %>)</span>
                            </div>
                            <img src="<%= user.avatar || '/img/default-avatar.png' %>" alt="Avatar" class="rounded-circle" width="40" height="40" onerror="this.src='/img/default-avatar.png'">
                        </div>
                    </div>
                </nav>

                <!-- Node Header -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h4 class="card-title mb-2">
                                            <%= node.name %>
                                            <% if (node.is_online) { %>
                                                <span class="badge bg-success ms-2 real-time-badge">
                                                    <i class="fas fa-circle me-1"></i>Online
                                                    <% if (node.latency) { %>
                                                        <span class="ms-1"><%= node.latency.toFixed(1) %> ms</span>
                                                    <% } %>
                                                </span>
                                            <% } else { %>
                                                <span class="badge bg-danger ms-2">
                                                    <i class="fas fa-circle me-1"></i>Offline
                                                    <% if (node.last_seen) { %>
                                                        <span class="ms-1">
                                                            <% if (node.last_seen) { %>
                                                                <%
                                                                    const lastSeen = new Date(node.last_seen);
                                                                    const now = new Date();
                                                                    const diffMs = now - lastSeen;
                                                            
                                                                    const diffMinutes = Math.floor(diffMs / 60000);
                                                                    const diffHours = Math.floor(diffMinutes / 60);
                                                                    const diffDays = Math.floor(diffHours / 24);
                                                            
                                                                    let lastSeenText;
                                                                    if (diffMinutes < 1) {
                                                                        lastSeenText = 'just now';
                                                                    } else if (diffMinutes < 60) {
                                                                        lastSeenText = diffMinutes + ' min ago';
                                                                    } else if (diffHours < 24) {
                                                                        lastSeenText = diffHours + ' hrs ago';
                                                                    } else {
                                                                        lastSeenText = diffDays + ' days ago';
                                                                    }
                                                                %>
                                                            
                                                                <span class="ms-1"><%= lastSeenText %></span>
                                                            <% } else { %>
                                                                <span class="text-muted">never</span>
                                                            <% } %>                                                            
                                                        </span>
                                                    <% } %>
                                                </span>
                                            <% } %>
                                        </h4>
                                        <div class="d-flex flex-wrap gap-2 mt-2">
                                            <% if (node.group_tags && node.group_tags.length > 0) { %>
                                                <% node.group_tags.forEach(function(tag) { %>
                                                    <span class="badge bg-primary">
                                                        <i class="fas fa-tag me-1"></i><%= tag %>
                                                    </span>
                                                <% }); %>
                                            <% } %>
                                            <span class="badge <%= node.monitor_type === 'agent' ? 'bg-success' : node.monitor_type === 'ping' ? 'bg-info' : 'bg-warning' %>">
                                                <i class="fas fa-<%= node.monitor_type === 'agent' ? 'microchip' : node.monitor_type === 'ping' ? 'network-wired' : 'code' %> me-1"></i>
                                                <%= (node.monitor_type || 'agent').toUpperCase() %>
                                            </span>
                                            <% if (node.public) { %>
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-eye me-1"></i>Public
                                                </span>
                                            <% } %>
                                            <% if (node.status_page_visible) { %>
                                                <span class="badge bg-info">
                                                    <i class="fas fa-globe me-1"></i>Status Page
                                                </span>
                                            <% } %>
                                        </div>
                                        <div class="row text-muted mt-2">
                                            <div class="col-auto">
                                                <i class="fas fa-globe me-1"></i>
                                                <%= node.ip_address || 'N/A' %>
                                                <% if (node.hostname) { %>
                                                    <small class="ms-1">(<%= node.hostname %>)</small>
                                                <% } %>
                                                <% if (node.ip_alias) { %>
                                                    <small class="ms-1">Alias: <%= node.ip_alias %></small>
                                                <% } %>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-map-marker-alt me-1"></i>
                                                <%= node.location || 'Unknown location' %>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Added: <%= new Date(node.created_at).toLocaleDateString() %>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-sync-alt me-1"></i>
                                                Updated: <%= new Date(node.updated_at).toLocaleDateString() %>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        <div class="node-header-actions">
                                            <a href="/admin/nodes/edit/<%= node.id %>" class="btn btn-outline-primary">
                                                <i class="fas fa-edit me-2"></i>Edit
                                            </a>
                                            <a href="/admin/export/stats" class="btn btn-outline-dark">
                                                <i class="fas fa-download me-2"></i>Export Data
                                            </a>
                                            <% if (user.role === 'admin') { %>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-danger dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                                    <i class="fas fa-trash me-2"></i>Delete
                                                </button>
                                                <ul class="dropdown-menu dropdown-menu-end">
                                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteNode(<%= node.id %>, '<%= node.name %>')">
                                                        <i class="fas fa-trash me-2"></i>Delete Node
                                                    </a></li>
                                                    <li><a class="dropdown-item text-warning" href="#" onclick="regenerateApiKey()">
                                                        <i class="fas fa-key me-2"></i>Regenerate API Key
                                                    </a></li>
                                                </ul>
                                            </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Real-time Stats (Powered by WebSocket) -->
                <div class="row mt-4" id="realtime-stats">
                    <div class="col-12 mb-3">
                        <h4>
                            <i class="fas fa-chart-line me-2"></i>Real-time System Metrics
                            <span class="badge bg-info ms-2">Live</span>
                            <small class="text-muted ms-2" id="last-update-time">Updating...</small>
                        </h4>
                    </div>
                    
                    <!-- Stats will be populated by WebSocket -->
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <div class="row" id="live-metrics-container">
                                    <div class="col-12 text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading live metrics...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Connecting to real-time updates...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Stats (From Database) -->
                <% if (stats.length > 0) { 
                    const latest = stats[0];
                %>
                <div class="row mt-4">
                    <div class="col-12 mb-3">
                        <h4><i class="fas fa-database me-2"></i>Latest Recorded Stats</h4>
                    </div>
                    
                    <!-- CPU Usage -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted mb-2">
                                            <i class="fas fa-microchip me-1"></i>CPU Usage
                                        </h6>
                                        <h3 class="<%= getUsageClass(latest.cpu_usage) %> mb-1">
                                            <%= (latest.cpu_usage || 0).toFixed(1) %>%
                                        </h3>
                                        <small class="text-muted">
                                            <%= latest.cpu_cores || 1 %> Cores
                                        </small>
                                        <div class="metric-trend mt-1" id="cpu-trend">
                                            <i class="fas fa-arrow-right me-1"></i>
                                            <span>Loading trend...</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge stat-badge <%= getUsageClass(latest.cpu_usage) %>">
                                            <%= getUsageLevel(latest.cpu_usage) %>
                                        </span>
                                        <% if (latest.cpu_temp) { %>
                                        <div class="temperature-indicator mt-2">
                                            <small><%= latest.cpu_temp %>°C</small>
                                            <div class="temp-bar">
                                                <div class="temp-fill" style="width: <%= Math.min(latest.cpu_temp / 100 * 100, 100) %>%"></div>
                                                <div class="temp-marker" style="left: 60%"></div>
                                                <div class="temp-marker" style="left: 80%"></div>
                                            </div>
                                            <small>100°C</small>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-primary" 
                                         style="width: <%= Math.min(latest.cpu_usage || 0, 100) %>%"></div>
                                </div>
                                <div class="mt-2 small text-muted">
                                    Alert threshold: <%= settings.cpu_threshold || 80 %>%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Memory Usage -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted mb-2">
                                            <i class="fas fa-memory me-1"></i>Memory
                                        </h6>
                                        <h3 class="<%= getUsageClass(latest.memory_usage) %> mb-1">
                                            <%= (latest.memory_usage || 0).toFixed(1) %>%
                                        </h3>
                                        <small class="text-muted">
                                            <%= formatBytes(latest.memory_total) %> Total
                                        </small>
                                        <div class="metric-trend mt-1" id="memory-trend">
                                            <i class="fas fa-arrow-right me-1"></i>
                                            <span>Loading trend...</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge stat-badge <%= getUsageClass(latest.memory_usage) %>">
                                            <%= getUsageLevel(latest.memory_usage) %>
                                        </span>
                                        <div class="mt-2 small">
                                            <span class="text-muted">Used: <%= formatBytes((latest.memory_usage / 100) * latest.memory_total) %></span>
                                            <br>
                                            <span class="text-muted">Free: <%= formatBytes(latest.memory_free) %></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-success" 
                                         style="width: <%= Math.min(latest.memory_usage || 0, 100) %>%"></div>
                                </div>
                                <div class="mt-2 small text-muted">
                                    Alert threshold: <%= settings.memory_threshold || 85 %>%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Disk Usage -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card metric-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title text-muted mb-2">
                                            <i class="fas fa-hdd me-1"></i>Disk
                                        </h6>
                                        <h3 class="<%= getUsageClass(latest.disk_usage) %> mb-1">
                                            <%= (latest.disk_usage || 0).toFixed(1) %>%
                                        </h3>
                                        <small class="text-muted">
                                            <%= formatBytes(latest.disk_total) %> Total
                                        </small>
                                        <div class="metric-trend mt-1" id="disk-trend">
                                            <i class="fas fa-arrow-right me-1"></i>
                                            <span>Loading trend...</span>
                                        </div>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge stat-badge <%= getUsageClass(latest.disk_usage) %>">
                                            <%= getUsageLevel(latest.disk_usage) %>
                                        </span>
                                        <div class="mt-2 small">
                                            <span class="text-muted">Used: <%= formatBytes((latest.disk_usage / 100) * latest.disk_total) %></span>
                                            <br>
                                            <span class="text-muted">Free: <%= formatBytes(latest.disk_free) %></span>
                                        </div>
                                    </div>
                                </div>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-warning" 
                                         style="width: <%= Math.min(latest.disk_usage || 0, 100) %>%"></div>
                                </div>
                                <div class="mt-2 small text-muted">
                                    Alert threshold: <%= settings.disk_threshold || 90 %>%
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Swap & System Info -->
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card metric-card">
                            <div class="card-body">
                                <!-- Swap Usage -->
                                <% if (latest.swap_total && latest.swap_total > 0) { 
                                    const swapUsed = latest.swap_total - latest.swap_free;
                                    const swapPercent = latest.swap_total > 0 ? (swapUsed / latest.swap_total) * 100 : 0;
                                %>
                                <h6 class="card-title text-muted mb-2">
                                    <i class="fas fa-exchange-alt me-1"></i>Swap Usage
                                </h6>
                                <h3 class="<%= getUsageClass(swapPercent) %> mb-1">
                                    <%= swapPercent.toFixed(1) %>%
                                </h3>
                                <div class="progress progress-thin mt-2">
                                    <div class="progress-bar bg-secondary" 
                                         style="width: <%= Math.min(swapPercent, 100) %>%"></div>
                                </div>
                                <div class="mt-2 small">
                                    <span class="text-muted">Total: <%= formatBytes(latest.swap_total) %></span>
                                    <br>
                                    <span class="text-muted">Free: <%= formatBytes(latest.swap_free) %></span>
                                </div>
                                <div class="mt-2 small text-muted">
                                    Alert threshold: <%= settings.swap_threshold || 80 %>%
                                </div>
                                <hr>
                                <% } %>
                                
                                <!-- Uptime -->
                                <h6 class="card-title text-muted mb-2">
                                    <i class="fas fa-clock me-1"></i>Uptime
                                </h6>
                                <h3 class="text-info mb-1"><%= formatUptime(latest.uptime) %></h3>
                                <small class="text-muted">
                                    <i class="fas fa-sync-alt me-1"></i>
                                    Updated: <%= timeAgo(new Date(latest.timestamp)) %>
                                </small>
                                <% if (latest.load_average) { 
                                    const load = JSON.parse(latest.load_average || '[0,0,0]');
                                %>
                                <div class="mt-2">
                                    <small class="text-muted">Load: <%= load[0]?.toFixed(2) || '0' %>, <%= load[1]?.toFixed(2) || '0' %>, <%= load[2]?.toFixed(2) || '0' %></small>
                                </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Resource Information -->
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">
                                    <i class="fas fa-info-circle me-2"></i>System Information
                                </h5>
                                <button class="btn btn-sm btn-outline-secondary" onclick="refreshNodeData()">
                                    <i class="fas fa-sync-alt me-1"></i>Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="system-info-grid">
                                    <!-- CPU Details -->
                                    <div class="resource-card">
                                        <h6 class="border-bottom pb-2">
                                            <i class="fas fa-microchip me-2 text-primary"></i>Processor
                                        </h6>
                                        <div class="info-item">
                                            <span class="info-label">Usage</span>
                                            <span class="info-value <%= getUsageClass(latest.cpu_usage) %>">
                                                <%= (latest.cpu_usage || 0).toFixed(1) %>%
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Cores</span>
                                            <span class="info-value"><%= latest.cpu_cores || 'N/A' %></span>
                                        </div>
                                        <% if (latest.cpu_temp) { %>
                                        <div class="info-item">
                                            <span class="info-label">Temperature</span>
                                            <span class="info-value <%= latest.cpu_temp > 80 ? 'usage-high' : latest.cpu_temp > 60 ? 'usage-medium' : 'usage-low' %>">
                                                <%= latest.cpu_temp %>°C
                                            </span>
                                        </div>
                                        <% } %>
                                        <div class="info-item">
                                            <span class="info-label">Processes</span>
                                            <span class="info-value"><%= latest.processes || 'N/A' %></span>
                                        </div>
                                    </div>

                                    <!-- Memory & Swap Details -->
                                    <div class="resource-card">
                                        <h6 class="border-bottom pb-2">
                                            <i class="fas fa-memory me-2 text-success"></i>Memory & Swap
                                        </h6>
                                        <div class="info-item">
                                            <span class="info-label">Memory Usage</span>
                                            <span class="info-value <%= getUsageClass(latest.memory_usage) %>">
                                                <%= (latest.memory_usage || 0).toFixed(1) %>%
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Memory Total</span>
                                            <span class="info-value"><%= formatBytes(latest.memory_total) %></span>
                                        </div>
                                        <% if (latest.swap_total && latest.swap_total > 0) { 
                                            const swapUsed = latest.swap_total - latest.swap_free;
                                            const swapPercent = latest.swap_total > 0 ? (swapUsed / latest.swap_total) * 100 : 0;
                                        %>
                                        <div class="info-item">
                                            <span class="info-label">Swap Usage</span>
                                            <span class="info-value <%= getUsageClass(swapPercent) %>">
                                                <%= swapPercent.toFixed(1) %>%
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Swap Total</span>
                                            <span class="info-value"><%= formatBytes(latest.swap_total) %></span>
                                        </div>
                                        <% } %>
                                    </div>

                                    <!-- Disk & Network Details -->
                                    <div class="resource-card">
                                        <h6 class="border-bottom pb-2">
                                            <i class="fas fa-hdd me-2 text-warning"></i>Storage & Network
                                        </h6>
                                        <div class="info-item">
                                            <span class="info-label">Disk Usage</span>
                                            <span class="info-value <%= getUsageClass(latest.disk_usage) %>">
                                                <%= (latest.disk_usage || 0).toFixed(1) %>%
                                            </span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Disk Total</span>
                                            <span class="info-value"><%= formatBytes(latest.disk_total) %></span>
                                        </div>
                                        <% if (latest.network_rx || latest.network_tx) { %>
                                        <div class="info-item">
                                            <span class="info-label">Network RX</span>
                                            <span class="info-value"><%= formatNetworkSpeed(latest.network_rx) %></span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Network TX</span>
                                            <span class="info-value"><%= formatNetworkSpeed(latest.network_tx) %></span>
                                        </div>
                                        <% } %>
                                    </div>

                                    <!-- System Details -->
                                    <div class="resource-card">
                                        <h6 class="border-bottom pb-2">
                                            <i class="fas fa-cog me-2 text-info"></i>System
                                        </h6>
                                        <div class="info-item">
                                            <span class="info-label">Uptime</span>
                                            <span class="info-value"><%= formatUptime(latest.uptime) %></span>
                                        </div>
                                        <% if (latest.os_version) { %>
                                        <div class="info-item">
                                            <span class="info-label">OS Version</span>
                                            <span class="info-value"><%= latest.os_version %></span>
                                        </div>
                                        <% } %>
                                        <div class="info-item">
                                            <span class="info-label">Last Report</span>
                                            <span class="info-value"><%= timeAgo(new Date(latest.timestamp)) %></span>
                                        </div>
                                        <div class="info-item">
                                            <span class="info-label">Monitor Type</span>
                                            <span class="info-value"><%= (node.monitor_type || 'agent').toUpperCase() %></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Controls -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="chart-controls">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-0">Historical Charts</h6>
                                </div>
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-end gap-2">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-primary active" data-chart-range="24h">
                                                24 Hours
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-chart-range="7d">
                                                7 Days
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-chart-range="30d">
                                                30 Days
                                            </button>
                                        </div>
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-success active" data-chart-type="line">
                                                <i class="fas fa-chart-line"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-success" data-chart-type="bar">
                                                <i class="fas fa-chart-bar"></i>
                                            </button>
                                        </div>
                                        <button class="btn btn-sm btn-outline-dark" onclick="exportChartData()">
                                            <i class="fas fa-download me-1"></i>Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Tabs -->
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <ul class="nav nav-tabs chart-tabs card-header-tabs" id="chartTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="cpu-tab" data-bs-toggle="tab" data-bs-target="#cpu-chart" type="button">
                                            <i class="fas fa-microchip me-2"></i>CPU
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="memory-tab" data-bs-toggle="tab" data-bs-target="#memory-chart" type="button">
                                            <i class="fas fa-memory me-2"></i>Memory
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="disk-tab" data-bs-toggle="tab" data-bs-target="#disk-chart" type="button">
                                            <i class="fas fa-hdd me-2"></i>Disk
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network-chart" type="button">
                                            <i class="fas fa-network-wired me-2"></i>Network
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="swap-tab" data-bs-toggle="tab" data-bs-target="#swap-chart" type="button">
                                            <i class="fas fa-exchange-alt me-2"></i>Swap
                                        </button>
                                    </li>
                                </ul>
                            </div>
                            <div class="card-body">
                                <div class="tab-content" id="chartTabContent">
                                    <div class="tab-pane fade show active" id="cpu-chart" role="tabpanel">
                                        <div class="chart-container">
                                            <canvas id="cpuChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="memory-chart" role="tabpanel">
                                        <div class="chart-container">
                                            <canvas id="memoryChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="disk-chart" role="tabpanel">
                                        <div class="chart-container">
                                            <canvas id="diskChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="network-chart" role="tabpanel">
                                        <div class="chart-container">
                                            <canvas id="networkChart"></canvas>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="swap-chart" role="tabpanel">
                                        <div class="chart-container">
                                            <canvas id="swapChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Configuration -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="api-key-container">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 class="text-white mb-2">
                                        <i class="fas fa-key me-2"></i>API Configuration
                                    </h5>
                                    <p class="text-white-50 mb-0">Use this API key to configure your monitoring agent</p>
                                </div>
                                <div class="btn-group">
                                    <button class="btn btn-light" onclick="copyApiKey()">
                                        <i class="fas fa-copy me-2"></i>Copy Key
                                    </button>
                                    <% if (user.role === 'admin') { %>
                                    <button class="btn btn-warning" onclick="regenerateApiKey()">
                                        <i class="fas fa-sync-alt me-2"></i>Regenerate
                                    </button>
                                    <% } %>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label text-white">API Key</label>
                                <div class="input-group">
                                    <input type="password" class="form-control bg-dark text-white border-dark" 
                                           value="<%= node.api_key_masked || maskApiKey(node.api_key) %>" 
                                           readonly id="apiKey" spellcheck="false">
                                    <button class="btn btn-outline-light" type="button" onclick="toggleApiKeyVisibility()">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body">
                                            <h6><i class="fas fa-code me-2"></i>Agent Configuration</h6>
                                            <pre class="bg-dark border rounded p-2 mt-2" style="font-size: 0.8rem;">
{
  "api_key": "<%= node.api_key %>",
  "server_url": "<%= req.protocol %>://<%= req.get('host') %>/api/node/report",
  "interval": 60,
  "node_name": "<%= node.name %>"
}</pre>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card bg-dark text-white">
                                        <div class="card-body">
                                            <h6><i class="fas fa-shield-alt me-2"></i>Security Information</h6>
                                            <ul class="list-unstyled mt-2">
                                                <li class="mb-1">
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    Keep this key secure
                                                </li>
                                                <li class="mb-1">
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    Rotate keys periodically
                                                </li>
                                                <li class="mb-1">
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    Never share publicly
                                                </li>
                                                <li>
                                                    <i class="fas fa-check-circle text-success me-2"></i>
                                                    Key generated: <%= new Date(node.created_at).toLocaleDateString() %>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Alerts -->
                <% if (alerts.length > 0) { %>
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="card-title mb-0">
                                        <i class="fas fa-bell me-2"></i>Recent Alerts
                                    </h5>
                                    <small class="text-muted">Thresholds: CPU <%= settings.cpu_threshold || 80 %>% | 
                                        Memory <%= settings.memory_threshold || 85 %>% | 
                                        Disk <%= settings.disk_threshold || 90 %>% | 
                                        Swap <%= settings.swap_threshold || 80 %>%</small>
                                </div>
                                <span class="badge bg-<%= alerts.filter(a => !a.resolved).length > 0 ? 'warning' : 'success' %>">
                                    <%= alerts.filter(a => !a.resolved).length %> Active
                                </span>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Type</th>
                                                <th>Message</th>
                                                <th>Severity</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% alerts.forEach(function(alert) { %>
                                            <tr class="<%= alert.resolved ? '' : 'table-warning' %>">
                                                <td>
                                                    <i class="fas fa-<%= getAlertIcon(alert.type) %> me-2"></i>
                                                    <%= alert.type.replace('_', ' ') %>
                                                </td>
                                                <td><%= alert.message %></td>
                                                <td>
                                                    <span class="badge bg-<%= getSeverityClass(alert.severity) %>">
                                                        <%= alert.severity %>
                                                    </span>
                                                </td>
                                                <td><%= new Date(alert.created_at).toLocaleString() %></td>
                                                <td>
                                                    <% if (alert.resolved) { %>
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-check me-1"></i>Resolved
                                                            <% if (alert.resolved_at) { %>
                                                                <br><small><%= new Date(alert.resolved_at).toLocaleDateString() %></small>
                                                            <% } %>
                                                        </span>
                                                    <% } else { %>
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-exclamation me-1"></i>Active
                                                        </span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <% if (!alert.resolved && ['admin', 'manager'].includes(user.role)) { %>
                                                    <button class="btn btn-sm btn-outline-success resolve-alert" data-id="<%= alert.id %>">
                                                        <i class="fas fa-check me-1"></i>Resolve
                                                    </button>
                                                    <% } %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>
                
                <!-- WebSocket Connection Status -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-plug me-1"></i>
                                        <span id="ws-status">Connecting to real-time updates...</span>
                                    </small>
                                    <small class="text-muted" id="refresh-rate">
                                        Auto-refresh: 30s
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% } else { %>
                <!-- No Stats Available -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-database fa-3x text-muted mb-3"></i>
                                <h4>No Statistics Available</h4>
                                <p class="text-muted mb-4">
                                    This node hasn't reported any statistics yet. Make sure the monitoring agent is properly configured.
                                </p>
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-primary" onclick="testApiConnection()">
                                        <i class="fas fa-plug me-2"></i>Test API Connection
                                    </button>
                                    <a href="/admin/nodes/edit/<%= node.id %>" class="btn btn-outline-primary">
                                        <i class="fas fa-edit me-2"></i>Edit Node
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <% } %>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Configuration
        const NODE_ID = <%= node.id %>;
        const NODE_NAME = '<%= node.name %>';
        let ws = null;
        let charts = {};
        let realTimeData = null;
        let historicalData = null;

        // WebSocket Connection
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                updateWsStatus('Connected', 'success');
                console.log('WebSocket connected for node:', NODE_NAME);
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                updateWsStatus('Connection error', 'danger');
            };
            
            ws.onclose = () => {
                updateWsStatus('Disconnected', 'danger');
                // Attempt to reconnect after 3 seconds
                setTimeout(() => {
                    if (ws?.readyState !== WebSocket.OPEN) {
                        updateWsStatus('Reconnecting...', 'warning');
                        connectWebSocket();
                    }
                }, 3000);
            };
        }

        function handleWebSocketMessage(data) {
            const now = new Date();
            document.getElementById('last-update-time').textContent = `Last update: ${now.toLocaleTimeString()}`;
            
            switch(data.type) {
                case 'init':
                    // Initial data from server
                    if (data.nodes) {
                        const nodeData = data.nodes.find(n => n.id === NODE_ID);
                        if (nodeData) {
                            updateRealTimeMetrics(nodeData);
                        }
                    }
                    if (data.alerts) {
                        updateAlertsCount(data.alerts);
                    }
                    break;
                    
                case 'node_update':
                    if (data.node && data.node.id === NODE_ID) {
                        updateRealTimeMetrics(data.node);
                        updateTrendAnalysis(data.node);
                    }
                    break;
                    
                case 'new_alert':
                    if (data.alert && data.alert.node_id === NODE_ID) {
                        showAlertNotification(data.alert);
                        updateAlertsCount([data.alert]);
                    }
                    break;
                    
                case 'alert_resolved':
                    // Could update UI if needed
                    break;
            }
        }

        function updateWsStatus(message, type) {
            const statusEl = document.getElementById('ws-status');
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.className = type === 'success' ? 'text-success' : 
                                   type === 'warning' ? 'text-warning' : 'text-danger';
            }
        }

        // Real-time Metrics Display
        function updateRealTimeMetrics(nodeData) {
            realTimeData = nodeData;
            
            const container = document.getElementById('live-metrics-container');
            if (!container) return;
            
            // Calculate swap usage if available
            let swapPercent = 0;
            let swapTotal = 0;
            let swapFree = 0;
            if (nodeData.swap && nodeData.swap.total > 0) {
                swapTotal = nodeData.swap.total;
                swapFree = nodeData.swap.free || 0;
                const swapUsed = swapTotal - swapFree;
                swapPercent = (swapUsed / swapTotal) * 100;
            }
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 ${getUsageClass(nodeData.cpu_usage)}">
                                ${(nodeData.cpu_usage || 0).toFixed(1)}%
                            </h2>
                            <small class="text-muted">CPU</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 ${getUsageClass(nodeData.memory_usage)}">
                                ${(nodeData.memory_usage || 0).toFixed(1)}%
                            </h2>
                            <small class="text-muted">Memory</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 ${getUsageClass(nodeData.disk_usage)}">
                                ${(nodeData.disk_usage || 0).toFixed(1)}%
                            </h2>
                            <small class="text-muted">Disk</small>
                        </div>
                    </div>
                    ${swapTotal > 0 ? `
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 ${getUsageClass(swapPercent)}">
                                ${swapPercent.toFixed(1)}%
                            </h2>
                            <small class="text-muted">Swap</small>
                        </div>
                    </div>
                    ` : ''}
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 text-info">
                                ${formatNetworkSpeed(nodeData.network_rx || 0)}
                            </h2>
                            <small class="text-muted">Download</small>
                        </div>
                    </div>
                    <div class="col-xl-2 col-md-4 col-6 mb-3">
                        <div class="text-center">
                            <h2 class="mb-0 text-info">
                                ${formatNetworkSpeed(nodeData.network_tx || 0)}
                            </h2>
                            <small class="text-muted">Upload</small>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                <i class="fas fa-microchip me-1"></i>
                                Cores: ${nodeData.cpu_cores || 1}
                                <i class="fas fa-memory ms-3 me-1"></i>
                                RAM: ${formatBytes(nodeData.memory_total || 0)}
                                <i class="fas fa-hdd ms-3 me-1"></i>
                                Disk: ${formatBytes(nodeData.disk_total || 0)}
                            </small>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                Latency: ${(nodeData.latency || 0).toFixed(1)}ms
                            </small>
                        </div>
                    </div>
                </div>
            `;
        }

        function updateTrendAnalysis(nodeData) {
            // This would compare current values with previous values to show trends
            // For now, we'll just show static trend data
            const trends = {
                cpu: calculateTrend('cpu', nodeData.cpu_usage),
                memory: calculateTrend('memory', nodeData.memory_usage),
                disk: calculateTrend('disk', nodeData.disk_usage)
            };
            
            Object.keys(trends).forEach(metric => {
                const el = document.getElementById(`${metric}-trend`);
                if (el) {
                    const trend = trends[metric];
                    el.innerHTML = `
                        <i class="fas fa-arrow-${trend.direction} me-1 ${trend.class}"></i>
                        <span class="${trend.class}">${trend.text}</span>
                    `;
                }
            });
        }

        function calculateTrend(metric, currentValue) {
            // In a real implementation, you would compare with historical data
            // For now, return neutral trend
            return {
                direction: 'right',
                class: 'trend-neutral',
                text: 'Stable'
            };
        }

        function updateAlertsCount(alerts) {
            const activeAlerts = alerts.filter(a => !a.resolved && a.node_id === NODE_ID);
            const badge = document.querySelector('.badge.bg-warning, .badge.bg-success');
            if (badge && activeAlerts.length > 0) {
                badge.textContent = `${activeAlerts.length} Active`;
                badge.className = 'badge bg-warning';
            }
        }

        function showAlertNotification(alert) {
            // Show browser notification if permitted
            if (Notification.permission === 'granted') {
                new Notification(`Alert: ${NODE_NAME}`, {
                    body: `${alert.type}: ${alert.message}`,
                    icon: '/img/logo.png'
                });
            }
            
            // Show in-page notification
            showToastNotification(alert);
        }

        function showToastNotification(alert) {
            const toast = document.createElement('div');
            toast.className = 'toast show position-fixed bottom-0 end-0 m-3';
            toast.style.zIndex = '1050';
            toast.innerHTML = `
                <div class="toast-header bg-${getSeverityClass(alert.severity)} text-white">
                    <i class="fas fa-bell me-2"></i>
                    <strong class="me-auto">New Alert</strong>
                    <small>${new Date().toLocaleTimeString()}</small>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    <strong>${alert.type.replace('_', ' ')}</strong><br>
                    ${alert.message}
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // API Key Functions
        function copyApiKey() {
            const apiKey = '<%= node.api_key %>';
            navigator.clipboard.writeText(apiKey).then(() => {
                showToast('API key copied to clipboard', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showToast('Failed to copy API key', 'danger');
            });
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const button = event.target.closest('button');
            if (input.type === 'password') {
                input.type = 'text';
                button.innerHTML = '<i class="fas fa-eye-slash"></i>';
                input.value = '<%= node.api_key %>';
            } else {
                input.type = 'password';
                button.innerHTML = '<i class="fas fa-eye"></i>';
                input.value = '<%= node.api_key_masked || maskApiKey(node.api_key) %>';
            }
        }

        function regenerateApiKey() {
            if (confirm('Are you sure you want to regenerate the API key?\n\nThe current key will become invalid immediately. Any monitoring agents using it will stop working until updated with the new key.')) {
                fetch(`/admin/nodes/regenerate-key/${NODE_ID}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('API key regenerated successfully!', 'success');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        showToast('Error: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error regenerating API key', 'danger');
                });
            }
        }

        // Chart Functions
        function initializeCharts() {
            loadHistoricalData('24h');
            
            // Initialize empty charts
            const chartConfigs = {
                'cpuChart': { label: 'CPU Usage (%)', color: '#3b82f6' },
                'memoryChart': { label: 'Memory Usage (%)', color: '#10b981' },
                'diskChart': { label: 'Disk Usage (%)', color: '#f59e0b' },
                'networkChart': { label: 'Network Speed (MB/s)', color: '#8b5cf6' },
                'swapChart': { label: 'Swap Usage (%)', color: '#6b7280' }
            };
            
            Object.keys(chartConfigs).forEach(chartId => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    charts[chartId] = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: chartConfigs[chartId].label,
                                data: [],
                                borderColor: chartConfigs[chartId].color,
                                backgroundColor: chartConfigs[chartId].color + '20',
                                borderWidth: 2,
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { mode: 'index', intersect: false }
                            },
                            scales: {
                                x: {
                                    display: true,
                                    title: { display: true, text: 'Time' }
                                },
                                y: {
                                    display: true,
                                    title: { display: true, text: 'Value' }
                                }
                            }
                        }
                    });
                }
            });
            
            // Chart control event listeners
            document.querySelectorAll('[data-chart-range]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-chart-range]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    loadHistoricalData(this.dataset.chartRange);
                });
            });
            
            document.querySelectorAll('[data-chart-type]').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('[data-chart-type]').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const type = this.dataset.chartType;
                    Object.values(charts).forEach(chart => {
                        chart.config.type = type;
                        chart.update();
                    });
                });
            });
        }

        async function loadHistoricalData(range) {
            try {
                const response = await fetch(`/api/node/stats/${NODE_ID}?limit=${getLimitForRange(range)}`);
                const data = await response.json();
                
                if (data.success && data.stats) {
                    historicalData = data.stats;
                    updateChartsWithData(data.stats);
                }
            } catch (error) {
                console.error('Error loading historical data:', error);
                showToast('Failed to load historical data', 'danger');
            }
        }

        function getLimitForRange(range) {
            switch(range) {
                case '24h': return 24 * 12; // 5-minute intervals
                case '7d': return 7 * 24 * 2; // 30-minute intervals
                case '30d': return 30 * 24; // 1-hour intervals
                default: return 100;
            }
        }

        function updateChartsWithData(stats) {
            if (!stats || stats.length === 0) return;
            
            // Prepare data for each chart
            const labels = stats.map(s => new Date(s.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
            
            // CPU Chart
            if (charts.cpuChart) {
                charts.cpuChart.data.labels = labels;
                charts.cpuChart.data.datasets[0].data = stats.map(s => s.cpu_usage || 0);
                charts.cpuChart.update();
            }
            
            // Memory Chart
            if (charts.memoryChart) {
                charts.memoryChart.data.labels = labels;
                charts.memoryChart.data.datasets[0].data = stats.map(s => s.memory_usage || 0);
                charts.memoryChart.update();
            }
            
            // Disk Chart
            if (charts.diskChart) {
                charts.diskChart.data.labels = labels;
                charts.diskChart.data.datasets[0].data = stats.map(s => s.disk_usage || 0);
                charts.diskChart.update();
            }
            
            // Network Chart (combine RX and TX)
            if (charts.networkChart) {
                charts.networkChart.data.labels = labels;
                charts.networkChart.data.datasets = [
                    {
                        label: 'Download',
                        data: stats.map(s => (s.network_rx || 0) / (1024 * 1024)), // Convert to MB/s
                        borderColor: '#8b5cf6',
                        backgroundColor: '#8b5cf620',
                        borderWidth: 2,
                        tension: 0.4
                    },
                    {
                        label: 'Upload',
                        data: stats.map(s => (s.network_tx || 0) / (1024 * 1024)), // Convert to MB/s
                        borderColor: '#ec4899',
                        backgroundColor: '#ec489920',
                        borderWidth: 2,
                        tension: 0.4
                    }
                ];
                charts.networkChart.update();
            }
            
            // Swap Chart (if available)
            if (charts.swapChart && stats[0].swap_total > 0) {
                charts.swapChart.data.labels = labels;
                charts.swapChart.data.datasets[0].data = stats.map(s => {
                    if (s.swap_total > 0) {
                        const swapUsed = s.swap_total - (s.swap_free || 0);
                        return (swapUsed / s.swap_total) * 100;
                    }
                    return 0;
                });
                charts.swapChart.update();
            }
        }

        function exportChartData() {
            if (!historicalData) {
                showToast('No data available to export', 'warning');
                return;
            }
            
            // Convert to CSV
            let csv = 'Timestamp,CPU (%),Memory (%),Disk (%),Network RX (B/s),Network TX (B/s),Swap (%),Processes\n';
            
            historicalData.forEach(stat => {
                const swapPercent = stat.swap_total > 0 ? 
                    ((stat.swap_total - (stat.swap_free || 0)) / stat.swap_total * 100).toFixed(1) : '0';
                
                csv += `"${stat.timestamp}",${stat.cpu_usage || 0},${stat.memory_usage || 0},${stat.disk_usage || 0},`;
                csv += `${stat.network_rx || 0},${stat.network_tx || 0},${swapPercent},${stat.processes || 0}\n`;
            });
            
            // Download CSV
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${NODE_NAME.replace(/\s+/g, '_')}_metrics_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('Data exported successfully', 'success');
        }

        // Utility Functions
        function refreshNodeData() {
            location.reload();
        }

        function testApiConnection() {
            showToast('Testing API connection...', 'info');
            // You could implement an actual API test here
        }

        function deleteNode(nodeId, nodeName) {
            if (confirm(`Are you sure you want to delete node "${nodeName}"?\n\nThis will permanently remove:\n• All statistics data\n• All alerts history\n• The node configuration\n\nThis action cannot be undone!`)) {
                fetch(`/admin/nodes/delete/${nodeId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Node deleted successfully', 'success');
                        setTimeout(() => window.location.href = '/admin/nodes', 1000);
                    } else {
                        showToast('Error: ' + data.error, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error deleting node', 'danger');
                });
            }
        }

        function showToast(message, type) {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast show position-fixed top-0 end-0 m-3`;
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Helper functions (mirroring server-side helpers)
        function formatBytes(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatNetworkSpeed(bytesPerSecond) {
            if (!bytesPerSecond || bytesPerSecond === 0) return '0 B/s';
            const k = 1024;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
            const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
            return parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function getUsageClass(usage) {
            if (usage >= 90) return 'usage-high';
            if (usage >= 70) return 'usage-medium';
            return 'usage-low';
        }

        function getSeverityClass(severity) {
            switch(severity) {
                case 'critical': return 'danger';
                case 'high': return 'danger';
                case 'warning': return 'warning';
                default: return 'info';
            }
        }

        function maskApiKey(key) {
            if (!key) return 'N/A';
            return `${key.slice(0, 8)}••••••••${key.slice(-8)}`;
        }

        // Request notification permission
        if (Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            connectWebSocket();
            <% if (stats.length > 0) { %>
            initializeCharts();
            <% } %>
            
            // Set up alert resolve buttons
            document.querySelectorAll('.resolve-alert').forEach(btn => {
                btn.addEventListener('click', function() {
                    const alertId = this.getAttribute('data-id');
                    fetch(`/admin/alerts/resolve/${alertId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('Alert resolved successfully', 'success');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            showToast('Error resolving alert', 'danger');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        showToast('Error resolving alert', 'danger');
                    });
                });
            });
        });
    </script>
</body>
</html>

<% 
// Server-side helper functions
function getUsageClass(usage) {
    if (usage >= 90) return 'usage-high';
    if (usage >= 70) return 'usage-medium';
    return 'usage-low';
}

function getUsageLevel(usage) {
    if (usage >= 90) return 'High';
    if (usage >= 70) return 'Medium';
    return 'Low';
}

function formatBytes(bytes) {
    if (!bytes || bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function formatNetworkSpeed(bytesPerSecond) {
    if (!bytesPerSecond || bytesPerSecond === 0) return '0 B/s';
    const k = 1024;
    const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s'];
    const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
    return parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatUptime(seconds) {
    const days = Math.floor(seconds / 86400);
    const hours = Math.floor((seconds % 86400) / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    
    if (days > 0) {
        return `${days}d ${hours}h ${minutes}m`;
    } else if (hours > 0) {
        return `${hours}h ${minutes}m`;
    } else if (minutes > 0) {
        return `${minutes}m`;
    } else {
        return '<1m';
    }
}

function timeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    
    if (interval > 1) return Math.floor(interval) + " years ago";
    interval = seconds / 2592000;
    if (interval > 1) return Math.floor(interval) + " months ago";
    interval = seconds / 86400;
    if (interval > 1) return Math.floor(interval) + " days ago";
    interval = seconds / 3600;
    if (interval > 1) return Math.floor(interval) + " hours ago";
    interval = seconds / 60;
    if (interval > 1) return Math.floor(interval) + " minutes ago";
    return Math.floor(seconds) + " seconds ago";
}

function getAlertIcon(type) {
    switch(type) {
        case 'cpu_high': return 'microchip';
        case 'memory_high': return 'memory';
        case 'disk_high': return 'hdd';
        case 'swap_high': return 'exchange-alt';
        case 'offline': return 'server';
        default: return 'exclamation-triangle';
    }
}

function getSeverityClass(severity) {
    switch(severity) {
        case 'critical': return 'danger';
        case 'high': return 'danger';
        case 'warning': return 'warning';
        default: return 'info';
    }
}

function maskApiKey(key) {
    if (!key) return 'N/A';
    return `${key.slice(0, 8)}••••••••${key.slice(-8)}`;
}
%>