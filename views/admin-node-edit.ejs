<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit <%= node.name %> - <%= settings.site_name %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: <%= settings.primary_color || '#6366f1' %>;
        }
        .sidebar {
            background: #1a1c23;
            min-height: 100vh;
            color: white;
        }
        .sidebar .nav-link {
            color: #b0b3b8;
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
        }
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background: var(--primary-color);
            color: white;
        }
        .tag-chip {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            margin: 0.25rem;
            display: inline-flex;
            align-items: center;
        }
        .tag-chip .remove {
            margin-left: 0.5rem;
            cursor: pointer;
            font-weight: bold;
        }
        .tag-input {
            border: none;
            outline: none;
            flex-grow: 1;
            min-width: 120px;
        }
        .tags-container {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            min-height: 38px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar (unchanged) -->
            <div class="col-md-3 col-lg-2 sidebar p-0">
                <div class="p-3">
                    <h4 class="text-center mb-4">
                        <i class="fas fa-server me-2"></i><%= settings.site_name %>
                    </h4>
                    <ul class="nav flex-column">
                        <li class="nav-item"><a class="nav-link" href="/admin"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/nodes"><i class="fas fa-server me-2"></i>Nodes</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/alerts"><i class="fas fa-bell me-2"></i>Alerts</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/users"><i class="fas fa-users me-2"></i>Users</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/settings"><i class="fas fa-cog me-2"></i>Settings</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/audit"><i class="fas fa-clipboard-list me-2"></i>Audit Logs</a></li>
                        <li class="nav-item"><a class="nav-link" href="/admin/profile"><i class="fas fa-user me-2"></i>Profile</a></li>
                        <li class="nav-item mt-3"><a class="nav-link text-danger" href="/admin/logout"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 ms-sm-auto px-4">
                <nav class="navbar navbar-light bg-white border-bottom py-3">
                    <div class="container-fluid">
                        <div class="d-flex align-items-center">
                            <a href="/admin/nodes/view/<%= node.id %>" class="btn btn-outline-secondary btn-sm me-2">
                                <i class="fas fa-arrow-left"></i>
                            </a>
                            <span class="navbar-brand">
                                <i class="fas fa-edit me-2"></i>Edit <%= node.name %>
                            </span>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="me-3">Welcome, <%= user.full_name || user.username %></span>
                            <img src="<%= user.avatar || '/img/default-avatar.png' %>" alt="Avatar" class="rounded-circle" width="40" height="40">
                        </div>
                    </div>
                </nav>

                <!-- Edit Form -->
                <div class="row mt-4">
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Node Information</h5>
                            </div>
                            <div class="card-body">
                                <form id="editNodeForm" method="POST" action="/admin/nodes/edit/<%= node.id %>">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Node Name *</label>
                                            <input type="text" class="form-control" name="name" value="<%= node.name %>" required minlength="1" maxlength="100">
                                            <div class="invalid-feedback">Name is required (1-100 characters)</div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Hostname / Address</label>
                                            <input type="text" class="form-control" name="hostname" value="<%= node.hostname || '' %>" placeholder="e.g. server.example.com">
                                        </div>
                                    </div>

                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">IP Alias / Friendly Name</label>
                                            <input type="text" class="form-control" name="ip_alias" value="<%= node.ip_alias || '' %>" placeholder="Optional display name">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Location</label>
                                            <input type="text" class="form-control" name="location" value="<%= node.location || 'Unknown' %>" placeholder="e.g. AWS eu-central-1">
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Group Tags</label>
                                        <div class="tags-container" id="tagsContainer">
                                            <% (node.group_tags || []).forEach(tag => { %>
                                                <span class="tag-chip">
                                                    <%= tag.trim() %>
                                                    <span class="remove" onclick="this.parentElement.remove()">×</span>
                                                    <input type="hidden" name="group_tags" value="<%= tag.trim() %>">
                                                </span>
                                            <% }) %>
                                            <input type="text" class="tag-input" id="tagInput" placeholder="Type tag and press Enter">
                                        </div>
                                        <small class="text-muted d-block mt-1">Press Enter or comma to add tags</small>
                                    </div>

                                    <div class="row mb-4">
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="public" id="publicCheck" <%= node.public ? 'checked' : '' %>>
                                                <label class="form-check-label" for="publicCheck">Public Node (API visible)</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" name="status_page_visible" id="statusCheck" <%= node.status_page_visible ? 'checked' : '' %>>
                                                <label class="form-check-label" for="statusCheck">Visible on Public Status Page</label>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Monitor Type</label>
                                            <select class="form-select" name="monitor_type">
                                                <option value="agent" <%= node.monitor_type === 'agent' ? 'selected' : '' %>>Agent (recommended)</option>
                                                <option value="ping" <%= node.monitor_type === 'ping' ? 'selected' : '' %>>Ping Only</option>
                                                <option value="custom" <%= node.monitor_type === 'custom' ? 'selected' : '' %>>Custom</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Current API Key + Regenerate -->
                                    <div class="mb-4">
                                        <label class="form-label">Current API Key</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" value="<%= node.api_key %>" readonly>
                                            <% if (user.role === 'admin') { %>
                                            <button class="btn btn-outline-warning" type="button" id="regenerateKeyBtn">
                                                <i class="fas fa-sync-alt me-2"></i>Regenerate Key
                                            </button>
                                            <% } %>
                                        </div>
                                        <small class="text-muted">Regenerating will invalidate the current key immediately.</small>
                                    </div>

                                    <div class="d-flex justify-content-between mt-4">
                                        <a href="/admin/nodes/view/<%= node.id %>" class="btn btn-secondary">Cancel</a>
                                        <button type="submit" class="btn btn-primary" id="submitBtn">
                                            <i class="fas fa-save me-2"></i>Update Node
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- Node Status -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="card-title mb-0">Node Status</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Status:</strong>
                                    <span class="badge <%= node.is_online ? 'bg-success' : 'bg-danger' %> ms-2">
                                        <%= node.is_online ? 'Online' : 'Offline' %>
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <strong>Last Seen:</strong><br>
                                    <small class="last-seen" data-timestamp="<%= node.last_seen || '' %>">
                                        <%= node.last_seen ? new Date(node.last_seen).toLocaleString() : 'Never' %>
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <strong>Created:</strong><br>
                                    <small><%= new Date(node.created_at).toLocaleString() %></small>
                                </div>
                                <div>
                                    <strong>Last Updated:</strong><br>
                                    <small><%= new Date(node.updated_at).toLocaleString() %></small>
                                </div>
                            </div>
                        </div>

                        <!-- Danger Zone -->
                        <% if (user.role === 'admin') { %>
                        <div class="card border-danger">
                            <div class="card-header bg-danger text-white">
                                <h6 class="card-title mb-0">Danger Zone</h6>
                            </div>
                            <div class="card-body">
                                <p class="small text-white-50 mb-3">
                                    Be careful — these actions cannot be undone.
                                </p>
                                <button class="btn btn-outline-light btn-sm w-100 mb-2 delete-node" 
                                        data-id="<%= node.id %>" 
                                        data-name="<%= node.name %>">
                                    <i class="fas fa-trash me-2"></i>Delete Node
                                </button>
                            </div>
                        </div>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. Relative time for last seen
        function updateRelativeTime() {
            const el = document.querySelector('.last-seen[data-timestamp]');
            if (!el || !el.dataset.timestamp) return;
            const ts = new Date(el.dataset.timestamp);
            const diff = Date.now() - ts.getTime();
            let text = 'Never';
            if (diff < 60000) text = 'just now';
            else if (diff < 3600000) text = Math.round(diff/60000) + ' min ago';
            else if (diff < 86400000) text = Math.round(diff/3600000) + ' hr ago';
            else text = ts.toLocaleDateString();
            el.textContent = text;
        }
        updateRelativeTime();
        setInterval(updateRelativeTime, 30000);

        // 2. Tags input with chips
        const tagContainer = document.getElementById('tagsContainer');
        const tagInput = document.getElementById('tagInput');

        function addTag(tag) {
            tag = tag.trim();
            if (!tag) return;
            const chip = document.createElement('span');
            chip.className = 'tag-chip';
            chip.innerHTML = `${tag}<span class="remove">×</span>`;
            const hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'group_tags';
            hidden.value = tag;
            chip.appendChild(hidden);
            chip.querySelector('.remove').onclick = () => chip.remove();
            tagContainer.insertBefore(chip, tagInput);
        }

        tagInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === ',') {
                e.preventDefault();
                addTag(tagInput.value);
                tagInput.value = '';
            }
        });

        tagInput.addEventListener('blur', () => {
            if (tagInput.value.trim()) {
                addTag(tagInput.value);
                tagInput.value = '';
            }
        });

        // 3. Delete confirmation
        document.querySelector('.delete-node')?.addEventListener('click', function() {
            const nodeId = this.dataset.id;
            const nodeName = this.dataset.name;
            if (confirm(`Delete "${nodeName}" and all stats/alerts permanently?`)) {
                fetch(`/admin/nodes/delete/${nodeId}`, { method: 'POST' })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) window.location = '/admin/nodes';
                        else alert('Delete failed: ' + (data.error || 'Unknown'));
                    })
                    .catch(() => alert('Network error'));
            }
        });

        // 4. Regenerate API key (admin only)
        document.getElementById('regenerateKeyBtn')?.addEventListener('click', function() {
            if (confirm('Regenerate API key?\nOld key becomes invalid instantly — agents will disconnect!')) {
                fetch(`/admin/nodes/regenerate-key/<%= node.id %>`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        alert('New API key generated!\nNew key: ' + data.api_key + '\nMasked: ' + data.masked);
                        // Optionally update the masked display
                        const input = document.querySelector('.input-group input[readonly]');
                        if (input) input.value = data.masked;
                    } else {
                        alert('Failed: ' + (data.error || 'Server error'));
                    }
                })
                .catch(() => alert('Network error'));
            }
        });

        // 5. Basic form validation before submit
        document.getElementById('editNodeForm').addEventListener('submit', function(e) {
            const nameInput = this.querySelector('[name="name"]');
            if (!nameInput.value.trim()) {
                e.preventDefault();
                nameInput.classList.add('is-invalid');
                nameInput.focus();
            }
        });
    </script>
</body>
</html>